<script>
document.addEventListener('DOMContentLoaded', () => {
    // COLE AQUI A URL DO SEU WEB APP (A QUE TERMINA COM /exec)
    const WEB_APP_URL = 'https://script.google.com/a/macros/onsv.org.br/s/AKfycbxoYs_PGBuofxe3JiQ-UOkQWvnOLlh8EmwTL769pmOsGP-O7UdZoWM0dvlqLnguh2dsvQ/exec';

    const form = document.getElementById('autoavaliacao-form');
    const questionarioWrapper = document.getElementById('questionario-wrapper');
    const resultadoWrapper = document.getElementById('resultado-wrapper');
    const btnConcluir = document.getElementById('btn-concluir');
    const resultadoFinalContainer = document.getElementById('resultado-final');
    const respostasCorrigidasContainer = document.getElementById('respostas-corrigidas');

    const correctAnswers = { q1: 'transito', q2: 'transito', q3: '15-29', q4: 'ambos', q5: 'motociclistas', q6: '3-pib', q7: 'velocidade', q8: '400-mais', q9: 'morte-frente', q10: 'investir' };
    
    function getDadosParticipanteFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const dados = {
            nome: urlParams.get('nome'), cpf: urlParams.get('cpf'), email: urlParams.get('email'),
            cidade: urlParams.get('cidade'), estado: urlParams.get('estado'), van: urlParams.get('van')
        };
        return (!dados.cpf || !dados.nome || !dados.email) ? null : dados;
    }

    form.addEventListener('submit', function(event) {
        event.preventDefault();

        if (!form.checkValidity()) {
            alert('Por favor, responda a todas as perguntas para continuar.');
            return;
        }

        const submitButton = form.querySelector('.btn-submit');
        submitButton.disabled = true;
        submitButton.textContent = 'Enviando...';
        
        let score = 0;
        Object.keys(correctAnswers).forEach(key => {
            const selected = form.querySelector(`input[name="${key}"]:checked`);
            if (selected && selected.value === correctAnswers[key]) score++;
        });
        
        const dadosParticipante = getDadosParticipanteFromURL();
        if (!dadosParticipante) {
            alert('Erro: Dados do participante não encontrados.');
            window.location.href = 'index.html';
            return;
        }

        const dataToSend = {
            questionarioTipo: 1, pontuacao: score,
            nome: decodeURIComponent(dadosParticipante.nome), cpf: decodeURIComponent(dadosParticipante.cpf),
            email: decodeURIComponent(dadosParticipante.email), cidade: decodeURIComponent(dadosParticipante.cidade), 
            estado: decodeURIComponent(dadosParticipante.estado), van: decodeURIComponent(dadosParticipante.van), 
            respostaQ11: document.getElementById('q11').value
        };

        // Envio simples e confiável
        fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors', // Importante para evitar erros de CORS com Google Scripts
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        })
        .catch(error => console.error('Fetch error:', error))
        .finally(() => {
            // O código continua para a tela de resultados, mesmo que o envio falhe, para não prejudicar a experiência do usuário.
            exibirResultados(score);
        });
    });
    
    function exibirResultados(score) {
        // A função de exibir resultados continua a mesma, com o bloqueio do botão "voltar"
        Object.keys(correctAnswers).forEach(key => {
            const selectedOption = form.querySelector(`input[name="${key}"]:checked`);
            if (selectedOption) {
                selectedOption.closest('label').classList.add(selectedOption.value === correctAnswers[key] ? 'correct' : 'incorrect');
            }
        });
        form.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
        form.querySelector('.btn-submit').style.display = 'none';
        respostasCorrigidasContainer.appendChild(form);
        resultadoFinalContainer.innerHTML = `Você acertou <span class="text-blue-600">${score}</span> de <span class="text-blue-600">${Object.keys(correctAnswers).length}</span> perguntas.`;
        questionarioWrapper.style.display = 'none';
        resultadoWrapper.style.display = 'block';
        btnConcluir.textContent = 'Concluir questionário, muito obrigado!';
        btnConcluir.onclick = () => { window.location.href = 'index.html'; };
        history.pushState(null, '', location.href); 
        window.addEventListener('popstate', function(event) { window.location.href = 'index.html'; });
    }
});
</script>
